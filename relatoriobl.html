<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Deboxe Customs - Relat√≥rio</title>

<link rel="icon" href="https://imgur.com/Nw9g2Q2.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/a2d9b1d7a1.js" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  background:#fff;
  padding-top:60px;
}
.box{
  background:#fff;
  padding:30px;
  border-radius:18px;
  max-width:780px;
  margin:auto;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
}
.checkbox-group{display:flex;flex-wrap:wrap;gap:12px}
.checkbox-group label{background:#eee;padding:7px 12px;border-radius:8px}
textarea{width:100%;height:220px;font-family:monospace}
</style>
</head>

<body>

<div class="box">
<h3 class="text-center">Relat√≥rio do Ba√∫</h3>

<label>Gerente Respons√°vel</label>
<input id="nome" class="form-control"
oninput="this.value=this.value.replace(/[^A-Za-z√Ä-√ø\s]/g,'')">

<label>ID Respons√°vel (Gerente)</label>
<input id="idM" class="form-control"
inputmode="numeric"
oninput="this.value=this.value.replace(/[^0-9]/g,'')">

<label>ID Comprador / Funcion√°rio</label>
<input id="idC" class="form-control"
inputmode="numeric"
oninput="this.value=this.value.replace(/[^0-9]/g,'')">

<label class="mt-3">Itens</label>
<div id="itens" class="checkbox-group mt-2"></div>

<button class="btn btn-success mt-3 w-100" onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
<button class="btn btn-primary mt-2 w-100" onclick="enviarDiscord()">
<i class="fa-brands fa-discord"></i> Enviar para o Discord
</button>

<textarea id="saida" readonly></textarea>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

/* ================= CONFIG ================= */
const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1463030474879533253/JWef5V8rb0fVTnAV8E6vjKPa5b7mbuV5KfgBlYASbhBDd-WQA0MJ3Gwgy-sNWqttMDIC";

// IDS DOS GERENTES AUTORIZADOS
const GERENTES = ["52853","48824","55586","53730"];

/* ================= FIREBASE ================= */
const app = initializeApp({
  apiKey:"AIzaSyD2zieCD4d-_olcWE6oOOqlepyxWvLGhyI",
  authDomain:"centralrace-c4ad0.firebaseapp.com",
  projectId:"centralrace-c4ad0"
});
const db = getFirestore(app);

/* ================= VARI√ÅVEIS ================= */
const container = document.getElementById("itens");
const saida = document.getElementById("saida");

let estoque = {};
let itensSelecionados = [];
let relatorioGerado = false;

/* ================= SEGURAN√áA ================= */
function ehGerente(){
  return GERENTES.includes(document.getElementById("idM").value.trim());
}

function validarDados(){
  const nome = document.getElementById("nome").value.trim();
  const idM  = document.getElementById("idM").value.trim();
  const idC  = document.getElementById("idC").value.trim();

  if(!/^[A-Za-z√Ä-√ø\s]{3,}$/.test(nome)){
    alert("‚ùå Nome inv√°lido. Use somente letras.");
    return false;
  }

  if(!/^[0-9]{3,}$/.test(idM)){
    alert("‚ùå ID do gerente inv√°lido.");
    return false;
  }

  if(!/^[0-9]{3,}$/.test(idC)){
    alert("‚ùå ID do funcion√°rio inv√°lido.");
    return false;
  }

  return true;
}

function bloquearTudo(){
  document.querySelectorAll("input,button").forEach(e=>e.disabled=true);
  saida.value="üö´ ACESSO RESTRITO\nSomente gerentes autorizados.";
}

function liberarTudo(){
  document.querySelectorAll("input,button").forEach(e=>e.disabled=false);
  saida.value="";
}

/* ================= EVENTO ID GERENTE ================= */
document.getElementById("idM").addEventListener("input",()=>{
  if(ehGerente()) liberarTudo();
  else bloquearTudo();
});

/* ================= ESTOQUE ================= */
async function carregarEstoque(){
  container.innerHTML="";
  estoque={};

  const snap = await getDocs(collection(db,"estoque"));
  snap.forEach(d=>{
    estoque[d.id]=d.data();
    const label=document.createElement("label");
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.value=d.id;
    label.appendChild(cb);
    label.append(` ${d.id} | Qtd: ${estoque[d.id].qtd}`);
    container.appendChild(label);
  });
}

/* ================= RELAT√ìRIO ================= */
window.gerarRelatorio = async function(){
  if(!ehGerente()) return alert("üö´ Apenas gerentes.");
  if(!validarDados()) return;

  const sel=[...document.querySelectorAll("input[type=checkbox]:checked")].map(i=>i.value);
  if(!sel.length) return alert("Selecione itens");

  let total=0;
  let texto=`üõ†Ô∏è RELAT√ìRIO DO BA√ö\n\n`;
  texto+=`üë§ Gerente: ${nome.value}\n`;
  texto+=`üÜî ID Gerente: ${idM.value}\n`;
  texto+=`üßæ ID Funcion√°rio: ${idC.value}\n\n`;

  sel.forEach(i=>{
    total+=estoque[i].preco;
    texto+=`${i} - R$ ${estoque[i].preco}\n`;
  });

  texto+=`\nTOTAL: R$ ${total}`;
  saida.value=texto;

  itensSelecionados=sel;
  relatorioGerado=true;
}

/* ================= DISCORD ================= */
window.enviarDiscord = async function(){
  if(!ehGerente()) return alert("üö´ Apenas gerentes.");
  if(!validarDados()) return;
  if(!relatorioGerado) return alert("Gere o relat√≥rio primeiro");

  await fetch(DISCORD_WEBHOOK,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      username:"Deboxe Relat√≥rios",
      embeds:[{
        title:"üõ†Ô∏è Relat√≥rio do Ba√∫",
        description:"```"+saida.value+"```",
        color:0xe10600
      }]
    })
  });

  for(const item of itensSelecionados){
    await updateDoc(doc(db,"estoque",item),{
      qtd: estoque[item].qtd - 1
    });
  }

  alert("Relat√≥rio enviado com sucesso!");
  relatorioGerado=false;
  itensSelecionados=[];
  carregarEstoque();
}

/* ================= INIT ================= */
bloquearTudo();
carregarEstoque();
</script>

</body>
</html>
