<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Deboxe Customs - Relat√≥rio</title>

<link rel="icon" href="https://imgur.com/Nw9g2Q2.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/a2d9b1d7a1.js" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --vermelho:#e10600;
  --dourado:#ffcc00;
}
*{user-select:none}
body{
  font-family:'Inter',sans-serif;
  background:#fff;
  color:#111;
  padding-top:130px;
}
.topbar{
  position:fixed;
  top:0;
  width:100%;
  z-index:1000;
  background:linear-gradient(90deg,#000,#1a0000,#000);
  border-bottom:3px solid var(--vermelho);
  padding:18px 0;
}
.logo{
  font-weight:800;
  font-size:1.35rem;
  background:linear-gradient(135deg,var(--vermelho),var(--dourado));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.nav-links a{
  color:#fff;
  margin-left:26px;
  font-weight:600;
  text-decoration:none;
}
.nav-links a:hover{color:var(--dourado)}
.discord-btn{
  margin-left:28px;
  padding:10px 18px;
  border-radius:16px;
  font-weight:700;
  background:linear-gradient(135deg,var(--vermelho),var(--dourado));
  color:#000;
  text-decoration:none;
}
.box{
  background:#fff;
  padding:30px;
  border-radius:18px;
  max-width:780px;
  margin:60px auto;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
}
.checkbox-group{display:flex;flex-wrap:wrap;gap:12px}
.checkbox-group label{background:#eee;padding:7px 12px;border-radius:8px}
textarea{width:100%;height:220px;font-family:monospace}

#adminBtn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:48px;
  height:48px;
  border-radius:50%;
  border:none;
  background:#ff9800;
  font-size:22px;
  font-weight:700;
  z-index:3000;
}
#adminPanel{
  display:none;
  margin-top:20px;
  background:#f1f1f1;
  padding:18px;
  border-radius:14px;
}
</style>
</head>

<body>

<!-- MENU -->
<header class="topbar">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <img src="https://imgur.com/Nw9g2Q2.png" height="80">
      <div class="logo">Deboxe Customs</div>
    </div>

    <nav class="d-none d-md-flex align-items-center nav-links">
      <a href="index.html">In√≠cio</a>
      <a href="tabela.html">Pre√ßos</a>
      <a href="funcionarios.html">Funcion√°rios</a>
      <a href="#" class="discord-btn">
        <i class="fa-brands fa-discord"></i> Discord
      </a>
    </nav>
  </div>
</header>

<!-- CONTE√öDO -->
<div class="box">
<h3 class="text-center">Relat√≥rio do Ba√∫</h3>

<label>Gerente Respons√°vel</label>
<input id="nome" class="form-control"
oninput="this.value=this.value.replace(/[^A-Za-z√Ä-√ø\s]/g,'')">

<label>ID Respons√°vel (Gerente)</label>
<input id="idM" class="form-control"
inputmode="numeric"
oninput="this.value=this.value.replace(/[^0-9]/g,'')">

<label>ID Mec√¢nico / Funcion√°rio</label>
<input id="idC" class="form-control"
inputmode="numeric"
oninput="this.value=this.value.replace(/[^0-9]/g,'')">

<label class="mt-3">Itens</label>
<div id="itens" class="checkbox-group mt-2"></div>

<button class="btn btn-success mt-3 w-100" onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
<button class="btn btn-primary mt-2 w-100" onclick="enviarDiscord()">
<i class="fa-brands fa-discord"></i> Enviar para o Discord
</button>

<textarea id="saida" readonly></textarea>

<div id="adminPanel">
  <h5>√Årea Administrativa</h5>
  <input class="form-control mt-2" placeholder="Painel restrito">
</div>
</div>

<button id="adminBtn">‚öôÔ∏è</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

/* ===== CONFIG ===== */
const DISCORD_WEBHOOK = "SEU_WEBHOOK_AQUI";
const GERENTES = ["52853","48824","55586","53730"];
const SENHA_ADMIN = "gerencia456";

/* ===== FIREBASE ===== */
const app = initializeApp({
  apiKey:"AIzaSyD2zieCD4d-_olcWE6oOOqlepyxWvLGhyI",
  authDomain:"centralrace-c4ad0.firebaseapp.com",
  projectId:"centralrace-c4ad0"
});
const db = getFirestore(app);

/* ===== VAR ===== */
const container = document.getElementById("itens");
const saida = document.getElementById("saida");
let estoque={}, itensSelecionados=[], relatorioGerado=false;

/* ===== SEGURAN√áA ===== */
function ehGerente(){
  return GERENTES.includes(idM.value.trim());
}

function validarNome(){
  return /^[A-Za-z√Ä-√ø\s]{3,}$/.test(nome.value.trim());
}

function bloquearTudo(){
  document.querySelectorAll("input,button").forEach(e=>e.disabled=true);
  saida.value="üö´ ACESSO RESTRITO\nSomente gerentes autorizados.";
}

function liberarTudo(){
  document.querySelectorAll("input,button").forEach(e=>e.disabled=false);
  saida.value="";
}

idM.addEventListener("input",()=>{
  ehGerente() ? liberarTudo() : bloquearTudo();
});

/* ===== ESTOQUE ===== */
async function carregarEstoque(){
  container.innerHTML="";
  const snap = await getDocs(collection(db,"estoque"));
  snap.forEach(d=>{
    estoque[d.id]=d.data();
    const l=document.createElement("label");
    const c=document.createElement("input");
    c.type="checkbox"; c.value=d.id;
    l.appendChild(c);
    l.append(` ${d.id} | Qtd: ${d.data().qtd}`);
    container.appendChild(l);
  });
}

/* ===== RELAT√ìRIO ===== */
window.gerarRelatorio=async()=>{
  if(!ehGerente()) return alert("üö´ Apenas gerentes.");
  if(!validarNome()) return alert("Nome inv√°lido.");

  const sel=[...document.querySelectorAll("input[type=checkbox]:checked")].map(i=>i.value);
  if(!sel.length) return alert("Selecione itens");

  let total=0;
  let txt=`üõ†Ô∏è RELAT√ìRIO DO BA√ö\n\nüë§ Gerente: ${nome.value}\nüÜî ID: ${idM.value}\nüßæ Mec√¢nico: ${idC.value}\n\n`;
  sel.forEach(i=>{ total+=estoque[i].preco; txt+=`${i} - R$ ${estoque[i].preco}\n`; });
  txt+=`\nTOTAL: R$ ${total}`;

  saida.value=txt;
  itensSelecionados=sel;
  relatorioGerado=true;
};

window.enviarDiscord=async()=>{
  if(!ehGerente()) return alert("üö´ Apenas gerentes.");
  if(!relatorioGerado) return alert("Gere o relat√≥rio primeiro");

  await fetch(DISCORD_WEBHOOK,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      embeds:[{title:"üõ†Ô∏è Relat√≥rio do Ba√∫",description:"```"+saida.value+"```",color:0xe10600}]
    })
  });

  for(const i of itensSelecionados){
    await updateDoc(doc(db,"estoque",i),{qtd:estoque[i].qtd-1});
  }

  alert("Relat√≥rio enviado!");
  relatorioGerado=false;
  carregarEstoque();
};

/* ===== ADMIN ===== */
adminBtn.onclick=()=>{
  const s=prompt("Senha admin:");
  if(s===SENHA_ADMIN){
    adminPanel.style.display=adminPanel.style.display==="block"?"none":"block";
  }else alert("Senha incorreta");
};

/* ===== INIT ===== */
bloquearTudo();
carregarEstoque();
</script>

</body>
</html>
