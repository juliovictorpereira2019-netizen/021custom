<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Central Race - Funcion√°rios</title>
<link rel="icon" href="https://imgur.com/0iskhD3.png">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:Inter,sans-serif;background:#f4f4f4}
.topbar{background:#2b2f33;color:#fff;padding:12px 0}
.logo{font-weight:700;font-size:18px}
.subtitulo{background:#ddd;text-align:center;font-weight:700;padding:6px;margin:30px 0 15px}

.card-employee{border-radius:16px;overflow:hidden;position:relative}
.card-employee img{
  height:180px;width:100%;object-fit:cover;
  pointer-events:none;user-select:none;-webkit-user-drag:none
}
.btn-remover{
  position:absolute;top:8px;right:8px;width:30px;height:30px;
  border-radius:50%;background:#dc3545;color:#fff;border:none;
  display:none;font-weight:700
}
.gerencia-mode .btn-remover{display:block}

.admin-btn{position:fixed;right:20px;bottom:20px;z-index:1001}
.admin-menu{
  position:fixed;right:-380px;top:0;width:380px;height:100%;
  background:#fff;box-shadow:-4px 0 20px rgba(0,0,0,.2);
  padding:20px;transition:.3s;z-index:1000
}
.admin-menu.open{right:0}

.badge-gerencia{
  display:none;background:#dc3545;color:#fff;
  font-weight:700;padding:6px 10px;border-radius:8px;font-size:12px
}
.gerencia-ativa .badge-gerencia{display:inline-block}
</style>
</head>

<body>

<header class="topbar">
  <div class="container d-flex align-items-center gap-3">
    <img src="https://imgur.com/0iskhD3.png" style="height:60px;border-radius:8px">
    <div class="logo">Central Race</div>
  </div>
</header>

<main class="container my-5">
  <h2 class="text-center mb-4">Nossa Equipe</h2>
  <div id="listaCargos"></div>
</main>

<button class="btn btn-dark admin-btn" onclick="abrirAdmin()">Acesso Mec√¢nico</button>
<button class="btn btn-danger admin-btn" style="bottom:70px" onclick="acessoGerencia()">Acesso Ger√™ncia</button>

<div class="admin-menu" id="adminMenu">
  <div class="d-flex justify-content-between align-items-center">
    <h5>Painel</h5>
    <span class="badge-gerencia">GER√äNCIA</span>
  </div>
  <hr>

  <label>Cargo</label>
  <select id="cargo" class="form-select mb-2" onchange="validarBotao()"></select>

  <label>Nome</label>
  <input id="nome" class="form-control mb-2">

  <label>Foto</label>
  <input id="foto" type="file" accept="image/*" class="form-control mb-3">

  <button id="btnAdd" class="btn btn-primary w-100" disabled onclick="adicionarVaga()">
    Adicionar vaga
  </button>
</div>

<script type="module">
/* CARGOS */
const CARGOS=[
  "Respons√°vel Mec√¢nico","L√≠der","Sub-L√≠der",
  "Gerente","Supervisor de Turnagem","Turnagem","Reparo"
];
const CARGOS_GERENCIA=[
  "Respons√°vel Mec√¢nico","L√≠der","Sub-L√≠der",
  "Gerente","Supervisor de Turnagem"
];

/* DISCORD */
const DISCORD_WEBHOOK="COLE_AQUI_A_URL_DO_WEBHOOK";

/* FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app=initializeApp({
  apiKey:"AIzaSyD2zieCD4d-_olcWE6O0QlepyxWLGhyI",
  authDomain:"centralrace-c4ad0.firebaseapp.com",
  projectId:"centralrace-c4ad0"
});
const db=getFirestore(app);

/* CLOUDINARY */
const CLOUD_NAME="dfyiwxdhn";
const UPLOAD_PRESET="funcionarios";
async function uploadImagem(f){
  const fd=new FormData();
  fd.append("file",f);
  fd.append("upload_preset",UPLOAD_PRESET);
  const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:fd});
  return (await r.json()).secure_url;
}

/* SENHAS */
const SENHA_ADMIN="admin123";
const SENHA_GERENCIA="gerencia456";
let gerenciaAtiva=false;

/* LOG */
async function logDiscord(acao,d){
  await fetch(DISCORD_WEBHOOK,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      username:"Central Race Logs",
      embeds:[{
        title:acao,
        color:acao.includes("ADICIONOU")?0x2ecc71:0xe74c3c,
        fields:[
          {name:"Funcion√°rio",value:d.nome,inline:true},
          {name:"Cargo",value:d.cargo,inline:true},
          {name:"Acesso",value:d.acesso,inline:true},
          {name:"Data",value:new Date().toLocaleString("pt-BR")}
        ]
      }]
    })
  });
}

/* SELECT */
function atualizarSelectCargo(){
  cargo.innerHTML='<option value="">Selecione</option>';
  CARGOS.forEach(c=>{
    if(CARGOS_GERENCIA.includes(c)&&!gerenciaAtiva)return;
    cargo.innerHTML+=`<option>${c}</option>`;
  });
  validarBotao();
}
window.validarBotao=()=>btnAdd.disabled=!cargo.value;

/* ADMIN */
window.abrirAdmin=()=>{
  if(prompt("Senha Admin:")===SENHA_ADMIN){
    adminMenu.classList.toggle("open");
    atualizarSelectCargo();
  }
};

/* GER√äNCIA */
window.acessoGerencia=()=>{
  if(prompt("Senha Ger√™ncia:")===SENHA_GERENCIA){
    gerenciaAtiva=true;
    document.body.classList.add("gerencia-mode","gerencia-ativa");
    atualizarSelectCargo();
    alert("Modo Ger√™ncia ativado");
  }
};

/* ADICIONAR */
window.adicionarVaga=async()=>{
  if(CARGOS_GERENCIA.includes(cargo.value)&&!gerenciaAtiva)return alert("Apenas ger√™ncia");
  if(!nome.value||!foto.files[0])return alert("Preencha tudo");

  const img=await uploadImagem(foto.files[0]);
  const ref=doc(db,"vagas",cargo.value);

  let lista=[];
  const snap=await getDocs(collection(db,"vagas"));
  snap.forEach(d=>{if(d.id===cargo.value)lista=d.data().lista||[]});

  lista.push({nome:nome.value,foto:img});
  await setDoc(ref,{lista});

  await logDiscord("‚ûï ADICIONOU FUNCION√ÅRIO",{
    nome:nome.value,cargo:cargo.value,
    acesso:gerenciaAtiva?"Ger√™ncia":"Mec√¢nico"
  });

  nome.value="";foto.value="";cargo.value="";
  validarBotao();
  renderizar();
};

/* REMOVER */
window.removerVaga=async(c,i)=>{
  if(!gerenciaAtiva)return alert("Acesso negado");

  const ref=doc(db,"vagas",c);
  let lista=[];
  const snap=await getDocs(collection(db,"vagas"));
  snap.forEach(d=>{if(d.id===c)lista=d.data().lista||[]});

  const r=lista[i];
  lista.splice(i,1);
  await setDoc(ref,{lista});

  await logDiscord("‚ùå REMOVEU FUNCION√ÅRIO",{
    nome:r.nome,cargo:c,acesso:"Ger√™ncia"
  });

  renderizar();
};

/* RENDER */
async function renderizar(){
  listaCargos.innerHTML="";
  const dados={};
  const snap=await getDocs(collection(db,"vagas"));
  snap.forEach(d=>dados[d.id]=d.data().lista||[]);
  CARGOS.forEach(c=>{
    const v=dados[c]||[];
    listaCargos.innerHTML+=`
    <div class="subtitulo">${c}</div>
    <div class="row">
      ${v.map((x,i)=>`
      <div class="col-md-3 mb-3">
        <div class="card card-employee">
          <button class="btn-remover" onclick="removerVaga('${c}',${i})">√ó</button>
          <img src="${x.foto}">
          <div class="card-body text-center">
            <h5>${x.nome}</h5>
            <p class="text-muted small">${c}</p>
          </div>
        </div>
      </div>`).join("")}
    </div>`;
  });
}

atualizarSelectCargo();
renderizar();

/* üîí PROTE√á√ïES */
document.addEventListener("contextmenu",e=>e.preventDefault());
document.addEventListener("dragstart",e=>e.preventDefault());
document.addEventListener("keydown",e=>{
  if(
    e.key==="F12" ||
    (e.ctrlKey && ["U","I","J","C","S"].includes(e.key.toUpperCase()))
  ){
    e.preventDefault();
  }
});
</script>

</body>
</html>
